---
layout: default	
title: Propensity Score Matching for Non-Binary Treatments
subtitle: Analyzing propensity score models with three groups.
published: true
status: publish
---


 
#### Introduction
 
The data represent newly enrolled students in a distance education program. By the nature of the program all students are considered part-time. Moreover, enrollment in the institution does not necessarily mean students are making active progress towards degree completion. To address this issue the institution began an outreach program whereby academic advisors would regularly contact new students within the first six months of enrollment until either six months have passed, or the student enrolled in some credit earning activity (generally a course or an examination for credit). Since randomization to receive the outreach was not possible, a comparison group was defined as students who enrolled six months prior to the start of the outreach. The treatment group is identified as students who enrolled six months after the start of the outreach and who received at least one academic advisor contact. 
 
Covariates for estimating propensity scores were retrieved from the student information system. The dependent variable of interest is the number of credits attempted within the first seven months of enrollment.
 
During the implementation phase it was identified that the outreach being conducted was substantially different between the two academic advisors responsible for the treatment. As such, it became necessary to treat each academic advisor as a separate treatment. The analysis of propensity score models for more than two groups (i.e. two treatments and one control) has relied on conducting three separate analyses. We outline here an approach to conducting propensity score analysis with three groups. 
 
#### Data preparation
 
First we will load the required R packages and data frame.
 

    require(mice)
    require(ggplot2)
    require(reshape)
    require(coin)
    require(multcomp)
    require(colorspace)
    require(psych)
    load("~/Dropbox/Projects/TriMatch/Data/students.rda")

 
There is a small amount of missingness so will impute missing values using the `mice` package.
 

    names(students)
    students = students[-which(students$TreatBy == "Both"), ]
    cols.model <- c("ACTIVE_MIL_STUDENT", "INCOME_RANGE_CODE_INT", "EMPLOYMENT_LVL_CODE", 
        "ENGLISH_LANGUAGE_NATIVE", "HIGHEST_ED_LVL_CODE_MOTHER_INT", "HIGHEST_ED_LVL_CODE_FATHER_INT", 
        "HAS_ASSOC_DEGREE", "ETHNICITY", "GENDER", "Age")
    students.mice <- mice(students[, cols.model])
    students.complete <- complete(students.mice, 5)

 
Lastly, we will create a `treat` variable that identifies our three groups.
 

    treat <- students$TreatBy
    treat[is.na(treat)] <- "Control"
    table(treat, useNA = "ifany")

    treat
       Control Treatment1 Treatment2 
           200         55         62 

 
#### Estimate Propensity Scores
 
The `triangle.psa` function will estimate three propensity score models.
 

    tpsa <- triangle.psa(students.complete, treat, ids = 1:nrow(students.complete))

 
 

    head(tpsa)

      id      treat model1 model2 model3       ps1    ps2 ps3 strata1 strata2
    1  1    Control  FALSE  FALSE     NA 1.164e-01 0.2135  NA       1       2
    2  2 Treatment1   TRUE     NA   TRUE 4.291e-01     NA   1       5    <NA>
    3  3    Control  FALSE  FALSE     NA 3.417e-01 0.1881  NA       5       2
    4  4    Control  FALSE  FALSE     NA 2.637e-01 0.1020  NA       4       1
    5  5    Control  FALSE  FALSE     NA 2.637e-01 0.1020  NA       4       1
    6  6    Control  FALSE  FALSE     NA 2.322e-08 0.1402  NA       1       1
      strata3
    1    <NA>
    2       5
    3    <NA>
    4    <NA>
    5    <NA>
    6    <NA>

    (p <- plot(tpsa))

![plot of chunk psaestimates](/images/trimatch/psaestimates.png) 

 
#### Matched Triplets
 

    tmatch <- triangle.match(tpsa)

      |                                                                              |                                                                      |   0%  |                                                                              |                                                                      |   1%  |                                                                              |                                                                      |   0%  |                                                                              |                                                                      |   1%  |                                                                              |=                                                                     |   1%  |                                                                              |                                                                      |   1%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   2%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |==                                                                    |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |===                                                                   |   5%  |                                                                              |===                                                                   |   4%  |                                                                              |===                                                                   |   5%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |=====                                                                 |   8%  |                                                                              |=====                                                                 |   7%  |                                                                              |=====                                                                 |   8%  |                                                                              |======                                                                |   8%  |                                                                              |=====                                                                 |   8%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |=======                                                               |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |=========                                                             |  14%  |                                                                              |==========                                                            |  14%  |                                                                              |=========                                                             |  13%  |                                                                              |=========                                                             |  14%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  15%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  16%  |                                                                              |============                                                          |  17%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |==============                                                        |  21%  |                                                                              |==============                                                        |  20%  |                                                                              |==============                                                        |  21%  |                                                                              |===============                                                       |  21%  |                                                                              |==============                                                        |  21%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  22%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  22%  |                                                                              |================                                                      |  23%  |                                                                              |================                                                      |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |=================                                                     |  25%  |                                                                              |=================                                                     |  24%  |                                                                              |=================                                                     |  25%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |===================                                                   |  28%  |                                                                              |===================                                                   |  27%  |                                                                              |===================                                                   |  28%  |                                                                              |====================                                                  |  28%  |                                                                              |===================                                                   |  28%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |=====================                                                 |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |=======================                                               |  34%  |                                                                              |========================                                              |  34%  |                                                                              |=======================                                               |  33%  |                                                                              |=======================                                               |  34%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  35%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  40%  |                                                                              |============================                                          |  41%  |                                                                              |============================                                          |  40%  |                                                                              |============================                                          |  41%  |                                                                              |=============================                                         |  41%  |                                                                              |============================                                          |  41%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  42%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |==============================                                        |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |===============================                                       |  44%  |                                                                              |===============================                                       |  45%  |                                                                              |===============================                                       |  44%  |                                                                              |===============================                                       |  45%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |=================================                                     |  48%  |                                                                              |=================================                                     |  47%  |                                                                              |=================================                                     |  48%  |                                                                              |==================================                                    |  48%  |                                                                              |=================================                                     |  48%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |===================================                                   |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |=====================================                                 |  54%  |                                                                              |======================================                                |  54%  |                                                                              |=====================================                                 |  53%  |                                                                              |=====================================                                 |  54%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  55%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  56%  |                                                                              |========================================                              |  57%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |==========================================                            |  61%  |                                                                              |==========================================                            |  60%  |                                                                              |==========================================                            |  61%  |                                                                              |===========================================                           |  61%  |                                                                              |==========================================                            |  61%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  62%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  62%  |                                                                              |============================================                          |  63%  |                                                                              |============================================                          |  62%  |                                                                              |============================================                          |  63%  |                                                                              |=============================================                         |  64%  |                                                                              |=============================================                         |  65%  |                                                                              |=============================================                         |  64%  |                                                                              |=============================================                         |  65%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |===============================================                       |  68%  |                                                                              |===============================================                       |  67%  |                                                                              |===============================================                       |  68%  |                                                                              |================================================                      |  68%  |                                                                              |===============================================                       |  68%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |=================================================                     |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |===================================================                   |  74%  |                                                                              |====================================================                  |  74%  |                                                                              |===================================================                   |  73%  |                                                                              |===================================================                   |  74%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  75%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  76%  |                                                                              |======================================================                |  77%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  80%  |                                                                              |========================================================              |  81%  |                                                                              |========================================================              |  80%  |                                                                              |========================================================              |  81%  |                                                                              |=========================================================             |  81%  |                                                                              |========================================================              |  81%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  82%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |==========================================================            |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |===========================================================           |  85%  |                                                                              |===========================================================           |  84%  |                                                                              |===========================================================           |  85%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |=============================================================         |  88%  |                                                                              |=============================================================         |  87%  |                                                                              |=============================================================         |  88%  |                                                                              |==============================================================        |  88%  |                                                                              |=============================================================         |  88%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |===============================================================       |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |=================================================================     |  94%  |                                                                              |==================================================================    |  94%  |                                                                              |=================================================================     |  93%  |                                                                              |=================================================================     |  94%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  95%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%

    head(tmatch)

      Treatment1 Treatment2 Control      D.m3      D.m2      D.m1   Dtotal
    1        270        265      79 0.0002014 0.0037999 0.0013720 0.005373
    2        301        137      45 0.0012392 0.0035476 0.0020470 0.006834
    3        287         17     179 0.0030548 0.0041807 0.0003809 0.007616
    4        317        251     229 0.0021912 0.0060408 0.0001084 0.008340
    5        268        315     116 0.0035292 0.0002079 0.0047251 0.008462
    6        124         92     174 0.0037004 0.0022147 0.0030896 0.009005

    plot(tmatch, rows = c(2), line.alpha = 1, draw.segments = TRUE)

![plot of chunk matches](/images/trimatch/matches1.png) 

    plot.distances(tmatch, sdfactor = c(0.1, 0.2, 0.5))

    Standard deviations of propensity scores: 0.11 + 0.094 + 0.22 = 0.42
    Percentage of matches exceding a distance of 0.042 (sdfactor = 0.1):
     FALSE   TRUE 
    0.8909 0.1091 
    Percentage of matches exceding a distance of 0.085 (sdfactor = 0.2):
      FALSE    TRUE 
    0.92727 0.07273 
    Percentage of matches exceding a distance of 0.21 (sdfactor = 0.5):
      FALSE    TRUE 
    0.96364 0.03636 

![plot of chunk matches](/images/trimatch/matches2.png) 

 
The distance plot shows that there are a few matches that have fairly large distances. The numbers on the left edge are the row numbers from `tmatch`. We can then use the `plot.triangle.matches` function with specifying the `rows` parameters to any or all of these values to investigate that matched triplet. The following figures shows that the large distances in due to the fact that only one data point has a very large propensity score in both model 1 and 2.
 

    tmatch[55, ]

       Treatment1 Treatment2 Control   D.m3     D.m2   D.m1 Dtotal
    55        307        305     214 0.1605 0.001421 0.6061 0.7681

    plot(tmatch, rows = c(55), line.alpha = 1, draw.segments = TRUE)

![plot of chunk followup](/images/trimatch/followup.png) 

 
#### Friedman Rank Sum Test
 

    tmatch.out <- merge(tmatch, students[, c("ECHOURS_ATTEMPTED_COURSES_CALC")])
    names(tmatch.out)

     [1] "Treatment1"     "Treatment2"     "Control"        "D.m3"          
     [5] "D.m2"           "D.m1"           "Dtotal"         "Treatment1.out"
     [9] "Treatment2.out" "Control.out"   

    plot.parallel(tmatch.out)

![plot of chunk merge](/images/trimatch/merge.png) 

 

    tmatch.out$id <- 1:nrow(tmatch.out)
    out <- melt(tmatch.out[, c("Treatment1.out", "Treatment2.out", "Control.out", "id")], 
        id.vars = "id")
    names(out) <- c("ID", "Treatment", "Outcome")
    head(out)

      ID      Treatment Outcome
    1  1 Treatment1.out       9
    2  2 Treatment1.out       0
    3  3 Treatment1.out       3
    4  4 Treatment1.out       6
    5  5 Treatment1.out       6
    6  6 Treatment1.out       0

    set.seed(2112)
    friedman.test.with.post.hoc(Outcome ~ Treatment | ID, out)

    [1] "The results where not significant, There is no need for a post hoc test"

    
    	Asymptotic General Independence Test
    
    data:  Outcome by
    	 Treatment (Treatment1.out, Treatment2.out, Control.out) 
    	 stratified by ID 
    maxT = 1.492, p-value = 0.295
    

 
 
#### References
 
Rosenbaum, P.R., & Rubin, D.B. (1983). The Central Role of the Propensity Score in Observational Studies for Causal Effects. *Biometrika, 70*(1).
 
[National Medical Expenditure Survey](http://dx.doi.org/10.3886/ICPSR09280.v1)
 
National Center for Health Services Research and Health Care Technology Assessment. NATIONAL MEDICAL EXPENDITURE SURVEY, 1987: INSTITUTIONAL POPULATION COMPONENT. Rockville, MD: Westat, Inc. [producer], 1987. Ann Arbor, MI: Inter-university Consortium for Political and Social Research [distributor], 1990. doi:10.3886/ICPSR09280.v1
